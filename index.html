<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡é‡ç‰¹è®­</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- å¼•å…¥ Markdown è§£æåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            /* ä¼˜åŒ–å­—ä½“ä»¥æ”¯æŒä¸­æ–‡å’Œç³»ç»Ÿé»˜è®¤ */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 320px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
        .stat-card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
            text-align: center;
        }
        .stat-number {
            font-size: 3rem;
            font-weight: 800;
            line-height: 1;
        }
        .stat-label {
            font-size: 1rem;
            font-weight: 500;
            color: #4B5563;
        }
        /* AI Section Styles */
        .ai-gradient {
            background: linear-gradient(135deg, #004080 0%, #00A6AD 100%);
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #005A8D;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .table-row-animate {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* === å…³é”®ä¼˜åŒ–åŒºåŸŸï¼šç¡®ä¿ Markdown è¾“å‡ºåœ¨ç§»åŠ¨ç«¯ä¸æº¢å‡º === */
        #foodResult, #analysisResult, #rescueResult {
            width: 100%; 
            overflow-x: hidden;
        }
        #foodResult *, #analysisResult *, #rescueResult * {
            word-break: break-word; 
            overflow-wrap: break-word; 
            max-width: 100%; 
        }
        /* é’ˆå¯¹ H4 æ ‡é¢˜ï¼Œé™åˆ¶å…¶å­—ä½“å¤§å°ä»¥é€‚åº”çª„å±å¹•ï¼Œå¹¶ç¡®ä¿è‡ªåŠ¨æ¢è¡Œ */
        h1, h2, h3, h4, h5, h6 {
            font-size: 1.125rem !important; /* å¼ºåˆ¶é™åˆ¶æ ‡é¢˜å¤§å° */
            font-weight: 700;
            line-height: 1.5;
            white-space: normal;
            margin-top: 0.5rem;
            margin-bottom: 0.25rem;
        }
        ul, ol {
            padding-left: 1.2rem;
            list-style-position: outside;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-bold text-[#004080] mb-4">ğŸ¯ 39å²èŒåœºç”·æ€§å‡é‡ç‰¹è®­è®¡åˆ’</h1>
            <p class="text-xl text-gray-600">(ç³–å°¿ç—…+ç—›é£ç‰¹åˆ«ç‰ˆ) - æ™ºèƒ½ç‰ˆ</p>
        </header>

        <!-- Weight Tracker Section (New) -->
        <section class="mb-12 bg-white rounded-xl shadow-lg overflow-hidden border-t-4 border-[#007399]">
            <div class="p-6 border-b border-gray-100">
                <h2 class="text-3xl font-bold text-[#005A8D] flex items-center gap-3">
                    âš–ï¸ æ¯æ—¥ä½“é‡æ‰“å¡ç«™
                </h2>
                <p class="text-gray-500 mt-1">æ¯å¤©æ—©ä¸Šç©ºè…¹è®°å½•ã€‚ä¸ºäº†æ–¹ä¾¿ï¼Œ**è¾“å…¥å’Œæ˜¾ç¤ºå•ä½éƒ½æ˜¯æ–¤** (å†…éƒ¨å­˜å‚¨ä¸º kg)ã€‚</p>
            </div>

            <div class="p-6 grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Input Area -->
                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <label class="block text-sm font-bold text-gray-700 mb-2">é€‰æ‹©æ—¥æœŸ</label>
                        <input type="date" id="weightDate" class="w-full p-3 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-[#007399]">
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <label class="block text-sm font-bold text-gray-700 mb-2">ä»Šæ—¥ä½“é‡ (æ–¤)</label>
                        <input type="number" id="weightValue" step="0.1" placeholder="ä¾‹å¦‚: 199.0" class="w-full p-3 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-[#007399]">
                    </div>
                    <button onclick="addWeightRecord()" class="w-full bg-[#007399] hover:bg-[#005A8D] text-white font-bold py-3 px-4 rounded-lg transition shadow-md flex justify-center items-center gap-2">
                        <span>â• è®°å½•ä½“é‡</span>
                    </button>
                    
                    <div class="border-t pt-4">
                         <h3 class="font-bold text-gray-700 mb-2">ğŸ¤– AI è¿›åº¦å¤ç›˜</h3>
                         <p class="text-xs text-gray-500 mb-3">è®© DeepSeek åˆ†æä½ çš„è¿‘æœŸæ•°æ®ï¼Œæ‰¾å‡ºé—®é¢˜æˆ–ç»™äºˆé¼“åŠ±ã€‚</p>
                         <button onclick="analyzeProgress()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition shadow-md flex justify-center items-center gap-2">
                            <span id="analyzeBtnText">âœ¨ åˆ†ææˆ‘çš„è¿›åº¦</span>
                        </button>
                    </div>
                </div>

                <!-- Chart Area -->
                <div class="lg:col-span-2">
                    <div class="bg-white p-2 rounded-lg h-full flex flex-col">
                         <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-gray-700">ä½“é‡è¶‹åŠ¿å›¾</h3>
                            <!-- Retain current weight display in the header -->
                            <span class="text-sm text-gray-500" id="currentWeightDisplay">å½“å‰: -- æ–¤</span>
                         </div>
                        <div class="chart-container flex-grow" style="height: 300px;">
                            <canvas id="progressChart"></canvas>
                        </div>
                        <div id="analysisResult" class="hidden mt-4 p-4 bg-purple-50 border border-purple-100 rounded-lg text-sm text-purple-900 break-words"></div>
                    </div>
                </div>
            </div>

            <!-- Recent History List -->
            <div class="px-6 pb-6">
                <h3 class="font-bold text-gray-700 mb-4">æœ€è¿‘è®°å½•</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3">æ—¥æœŸ</th>
                                <th scope="col" class="px-6 py-3">ä½“é‡ (æ–¤)</th>
                                <th scope="col" class="px-6 py-3">å˜åŒ–</th>
                                <th scope="col" class="px-6 py-3">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="weightHistoryBody">
                            <!-- Rows will be added here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- AI Assistant Section -->
        <section class="mb-12 bg-white rounded-xl shadow-lg overflow-hidden border-2 border-[#00A6AD]">
            <div class="ai-gradient p-6 text-white">
                <h2 class="text-3xl font-bold flex items-center justify-center gap-3">
                    <span>âœ¨</span> AI æ™ºèƒ½å¥åº·é¡¾é—® <span>âœ¨</span>
                </h2>
                <p class="text-center text-blue-100 mt-2">ç”± DeepSeek æ™ºèƒ½æ¨¡å‹é©±åŠ¨ï¼Œé’ˆå¯¹æ‚¨çš„ç³–å°¿ç—…å’Œç—›é£ä½“è´¨æä¾›å®æ—¶å»ºè®®</p>
            </div>
            
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Feature 1: Food Analyzer -->
                <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                    <h3 class="text-xl font-bold text-[#005A8D] mb-4 flex items-center">
                        ğŸ½ï¸ é£Ÿç‰©â€œæ‰«é›·â€å™¨
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">ä¸ç¡®å®šé£Ÿå ‚çš„è¿™é“èœèƒ½ä¸èƒ½åƒï¼Ÿè¾“å…¥èœåï¼ŒAI ä¼šæ ¹æ®æ‚¨çš„ç—…å²ï¼ˆæ§ç³–+æ§é…¸ï¼‰ç»™å‡ºçº¢ç»¿ç¯åˆ¤æ–­ã€‚</p>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="foodInput" placeholder="ä¾‹å¦‚ï¼šçº¢çƒ§è‚‰ã€éº»è¾£çƒ«ã€æ¸…è’¸é±¼..." 
                            class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#00A6AD] focus:border-transparent outline-none">
                        <button onclick="analyzeFood()" class="bg-[#007399] hover:bg-[#005A8D] text-white px-6 py-3 rounded-lg font-bold transition-colors flex items-center">
                            <span id="foodBtnText">åˆ†æ</span>
                        </button>
                    </div>
                    <!-- å…³é”®ä¼˜åŒ–ï¼šä½¿ç”¨ w-full ç¡®ä¿å…¨å®½ï¼Œå¹¶è®© CSS style å—å¤„ç†å†…éƒ¨ Markdown å…ƒç´ çš„æ¢è¡Œå’Œå­—ä½“å¤§å° -->
                    <div id="foodResult" class="hidden w-full bg-white p-4 rounded border border-gray-200 text-gray-700 text-sm leading-relaxed min-h-[100px]"></div>
                </div>

                <!-- Feature 2: SOS Motivation -->
                <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                    <h3 class="text-xl font-bold text-[#005A8D] mb-4 flex items-center">
                        ğŸ†˜ æ·±å¤œâ€œé˜²ç ´æˆ’â€æ€¥æ•‘
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">æ™šä¸Š11ç‚¹é¥¿å¾—æƒ³ç‚¹å¤–å–ï¼Ÿåœ¨ä¸‹å•å‰ç‚¹å‡»è¿™ä¸ªæŒ‰é’®ï¼Œè·å–é’ˆå¯¹æ€§çš„å¿ƒç†å¹²é¢„ã€‚</p>
                    <button onclick="getMotivation()" class="w-full bg-red-500 hover:bg-red-600 text-white p-4 rounded-lg font-bold text-lg transition-colors shadow-md mb-4 flex justify-center items-center gap-2">
                        <span id="sosBtnIcon">ğŸš¨</span> <span id="sosBtnText">æˆ‘æƒ³ç‚¹å¤–å–ï¼æ•‘æ•‘æˆ‘ï¼</span>
                    </button>
                    <div id="sosResult" class="hidden bg-red-50 p-4 rounded border border-red-100 text-red-800 italic text-center min-h-[80px]"></div>
                </div>
            </div>
        </section>

        <section class="mb-12">
            <h2 class="text-3xl font-bold text-center text-[#005A8D] mb-6">æ ¸å¿ƒç›®æ ‡ï¼š4ä¸ªæœˆå‡é‡ 50æ–¤</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="stat-card">
                    <!-- CHANGED ID and Label: èµ·å§‹ä½“é‡ -->
                    <div class="stat-number text-[#007399]" id="initialWeightStat">--<span class="text-2xl">æ–¤</span></div>
                    <div class="stat-label">èµ·å§‹ä½“é‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number text-[#00A6AD]">150<span class="text-2xl">æ–¤</span></div>
                    <div class="stat-label">ç›®æ ‡ä½“é‡</div>
                </div>
                <div class="stat-card">
                    <!-- CHANGED ID and Label: å·²å‡ä½“é‡ -->
                    <div class="stat-number text-[#008CA6]" id="weightLostStat">--<span class="text-2xl">æ–¤</span></div>
                    <div class="stat-label">å·²å‡ä½“é‡</div>
                </div>
            </div>
        </section>

        <section class="bg-white rounded-lg shadow-md p-6 mb-12">
            <h2 class="text-3xl font-bold text-center text-[#005A8D] mb-6">4ä¸ªæœˆå‡é‡ç›®æ ‡åˆ†è§£ï¼ˆç‡ƒå°½å›¾ï¼‰</h2>
            <p class="text-center text-gray-600 mb-6">è™šçº¿å±•ç¤ºäº†åŸºäºæ‚¨è¿‘3å‘¨è¡¨ç°çš„<b>â€œç”Ÿç†å­¦â€è¶‹åŠ¿é¢„æµ‹</b>ã€‚å®ƒè€ƒè™‘äº†å‡é‡è¿‡ç¨‹ä¸­ä»£è°¢é€‚åº”å¸¦æ¥çš„é€Ÿåº¦è¡°å‡ï¼ˆå¹³å°æœŸæ•ˆåº”ï¼‰ï¼Œæ¯”ç›´çº¿é¢„æµ‹æ›´çœŸå®ã€‚</p>
            <div class="chart-container">
                <canvas id="weightLossTimeline"></canvas>
            </div>
        </section>
        
        <section class="mb-12">
            <h2 class="text-3xl font-bold text-center text-[#005A8D] mb-6">æ ¸å¿ƒç­–ç•¥ï¼šç¨³è¡€ç³– + é™å˜Œå‘¤ + ä¼˜ç¡çœ </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="stat-card bg-[#E0F7FA] border border-[#B2EBF2]">
                    <div class="stat-number text-5xl mb-2">ğŸ“ˆ</div>
                    <div class="stat-label font-bold text-[#007399]">ç¨³å®šè¡€ç³– (é˜²æš´é£Ÿ)</div>
                    <p class="text-gray-600 mt-2">ä¸­åˆå¿…é¡»åƒä¸»é£Ÿï¼Œé˜²æ­¢å¤œé—´ä½è¡€ç³–å¯¼è‡´å¤±æ§æ€§æš´é£Ÿã€‚</p>
                </div>
                <div class="stat-card bg-[#E0F2F1] border border-[#B2DFDB]">
                    <div class="stat-number text-5xl mb-2">ğŸ’§</div>
                    <div class="stat-label font-bold text-[#008CA6]">é™ä½å˜Œå‘¤ (é˜²ç—›é£)</div>
                    <p class="text-gray-600 mt-2">ä¸¥ç¦å–é£Ÿå ‚è‚‰æ±¤å’Œå†…è„ã€‚æ¯æ—¥å¿…é¡»å–è¶³3000mlæ°´ã€‚</p>
                </div>
                <div class="stat-card bg-[#F1F8E9] border border-[#DCEDC8]">
                    <div class="stat-number text-5xl mb-2">ğŸ˜´</div>
                    <div class="stat-label font-bold text-[#689F38]">æ”¹å–„ç¡çœ  (é˜²å¤œå®µ)</div>
                    <p class="text-gray-600 mt-2">ä¸‹åˆ4ç‚¹åä¸¥ç¦å’–å•¡å› ï¼Œä¿è¯11ç‚¹å‰å…¥ç¡ï¼Œé¿å…é¥¥é¥¿ç´ çˆ†å‘ã€‚</p>
                </div>
            </div>
        </section>

        <section class="bg-white rounded-lg shadow-md p-6 mb-12">
            <h2 class="text-3xl font-bold text-center text-[#005A8D] mb-6">ğŸ›‘ â€œä¿å‘½â€åŸåˆ™ï¼šå››å¤§ç¦ä»¤</h2>
            <ul class="space-y-4">
                <li class="flex items-center p-4 bg-red-50 rounded-lg border border-red-200">
                    <span class="text-4xl mr-4">âŒ</span>
                    <div>
                        <h3 class="font-bold text-red-800 text-xl">ç»å¯¹ç¦æ­¢å–é£Ÿå ‚çš„â€œå…è´¹æ±¤â€</h3>
                        <p class="text-red-700">åŸå› æ˜¯ï¼šé«˜å˜Œå‘¤ + é«˜æ²¹è„‚ï¼Œæ˜¯ç—›é£å’Œè‚¥èƒ–çš„ç‚¸å¼¹ã€‚</p>
                    </div>
                </li>
                <li class="flex items-center p-4 bg-red-50 rounded-lg border border-red-200">
                    <span class="text-4xl mr-4">âŒ</span>
                    <div>
                        <h3 class="font-bold text-red-800 text-xl">ç»å¯¹ç¦æ­¢â€œå®Œå…¨ä¸åƒä¸»é£Ÿâ€</h3>
                        <p class="text-red-700">åŸå› æ˜¯ï¼šä¼šå¼•å‘å¤œé—´ä¸¥é‡ä½è¡€ç³–ï¼Œå¯¼è‡´æš´é£Ÿç¢³æ°´ï¼Œå‰åŠŸå°½å¼ƒã€‚</p>
                    </div>
                </li>
                <li class="flex items-center p-4 bg-red-50 rounded-lg border border-red-200">
                    <span class="text-4xl mr-4">âŒ</span>
                    <div>
                        <h3 class="font-bold text-red-800 text-xl">æ™šä¸Šç»å¯¹ç¦æ­¢å–å«å’–å•¡å› é¥®å“</h3>
                        <p class="text-red-700">åŸå› æ˜¯ï¼šå’–å•¡å› å¯¼è‡´æ·±å¤œå…´å¥‹æ— æ³•å…¥ç¡ï¼Œæ˜¯é¥¥é¥¿ç´ çˆ†å‘çš„å…ƒå‡¶ã€‚</p>
                    </div>
                </li>
                <li class="flex items-center p-4 bg-red-50 rounded-lg border border-red-200">
                    <span class="text-4xl mr-4">âŒ</span>
                    <div>
                        <h3 class="font-bold text-red-800 text-xl">æ¸…ç†å®¶ä¸­é›¶é£Ÿé»‘åå•</h3>
                        <p class="text-red-700">ä¸¥ç¦ï¼šç“œå­ï¼ˆçƒ­é‡ç‚¸å¼¹ï¼‰ã€é¦™è•‰ï¼ˆé«˜ç³–ï¼‰ã€ä¸€åˆ‡å¤–å–ï¼ˆé«˜æ²¹é«˜ç›ï¼‰ã€‚</p>
                    </div>
                </li>
            </ul>
        </section>

        <section class="bg-white rounded-lg shadow-md p-6 mb-12">
            <h2 class="text-3xl font-bold text-center text-[#005A8D] mb-6">ğŸ½ï¸ é£Ÿå ‚æˆ˜æœ¯ï¼šåˆé¤â€œè¿‡æ°´â€æ³•</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                
                <div>
                    <h3 class="font-bold text-xl text-[#007399] mb-4">ä¸¥æ ¼æ‰§è¡Œé¡ºåºå’ŒæŠ€å·§</h3>
                    <ol class="list-decimal list-inside space-y-3 text-gray-700">
                        <li><strong class="text-gray-900">è¿›é£Ÿé¡ºåºï¼š</strong> å…ˆå–æ°´ â” åƒè”¬èœ â” åƒè‚‰ â” æœ€ååƒä¸»é£Ÿã€‚</li>
                        <li><strong class="text-gray-900">ä¸»é£Ÿï¼ˆå¿…åƒï¼‰ï¼šï¼š</strong> 1æ‹³å¤´å¤§å°ï¼ˆä¼˜é€‰æ‚ç²®é¥­ã€ç‰ç±³ï¼‰ã€‚</li>
                        <li><strong class="text-gray-900">è›‹ç™½è´¨ï¼šï¼š</strong> ä¼˜é€‰å»çš®é¸¡é¸­ã€æ·¡æ°´é±¼ã€é¸¡è›‹ã€‚</li>
                        <li><strong class="text-gray-900">ç—›é£è­¦æƒ•ï¼šï¼š</strong> ç¦åƒå†…è„ã€è´ç±»ã€æµ“è‚‰æ±¤ã€‚</li>
                        <li><strong class="text-gray-900">â€œè¿‡æ°´â€åŠ¨ä½œï¼šï¼š</strong> å‡†å¤‡ä¸€æ¯æ¸©æ°´ï¼Œæ‰€æœ‰æ²¹è…»ç‚’èœå¿…é¡»æ¶®æ²¹åå†åƒï¼</li>
                        <li><strong class="text-gray-900">é¥­åè¿åŠ¨ï¼šï¼š</strong> å¿…é¡»æ•£æ­¥1å…¬é‡Œï¼Œæ¶ˆè€—é¤åè¡€ç³–ã€‚</li>
                    </ol>
                </div>
            </div>
        </section>

        <section class="mb-12">
            <h2 class="text-3xl font-bold text-center text-[#005A8D] mb-6">â° æ¯æ—¥ä¸¥æ ¼æ‰§è¡Œæ—¶åˆ»è¡¨</h2>
            <div class="relative pl-8">
                <div class="absolute left-4 top-0 bottom-0 w-1 bg-[#00A6AD] rounded"></div>
                
                <div class="relative mb-8">
                    <div class="absolute -left-12 top-0 flex items-center justify-center w-10 h-10 bg-[#008CA6] text-white rounded-full font-bold">ğŸŒ…</div>
                    <div class="ml-4 p-6 bg-white rounded-lg shadow-md">
                        <h3 class="font-bold text-xl text-[#007399] mb-2">07:00 - 09:00 æ—©æ™¨</h3>
                        <ul class="list-disc list-inside text-gray-700">
                            <li>èµ·åºŠå– 500ml æ¸©æ°´ (æ³¨æ„ç›‘æµ‹æœè¯åçš„è¡€ç³–)ã€‚</li>
                            <li>ä¿ç•™ç‘å¹¸çƒ­ç¾å¼ï¼ˆæ— ç³–ï¼‰ï¼ŒåŠ é€Ÿä»£è°¢ã€‚</li>
                        </ul>
                    </div>
                </div>

                <div class="relative mb-8">
                    <div class="absolute -left-12 top-0 flex items-center justify-center w-10 h-10 bg-[#008CA6] text-white rounded-full font-bold">ğŸŒ</div>
                    <div class="ml-4 p-6 bg-white rounded-lg shadow-md">
                        <h3 class="font-bold text-xl text-[#007399] mb-2">12:00 åˆé¤</h3>
                        <p class="text-gray-700">ä¸¥æ ¼æ‰§è¡Œâ€œé£Ÿå ‚æˆ˜æœ¯â€ï¼ˆè§ä¸Šå›¾ï¼‰ã€‚</p>
                    </div>
                </div>

                <div class="relative mb-8">
                    <div class="absolute -left-12 top-0 flex items-center justify-center w-10 h-10 bg-[#008CA6] text-white rounded-full font-bold">ğŸŒ‡</div>
                    <div class="ml-4 p-6 bg-white rounded-lg shadow-md">
                        <h3 class="font-bold text-xl text-[#007399] mb-2">16:00 é˜²å¾¡æ€§åŠ é¤</h3>
                        <p class="text-gray-700">ä¸ºé˜²æ­¢æ™šé¤å¤±æ§ã€‚é¦–é€‰ï¼šä¸€æ ¹é»„ç“œ/å°ç•ªèŒ„ æˆ– ä¸€å°æ¯æ— ç³–é…¸å¥¶ã€‚</p>
                    </div>
                </div>

                <div class="relative mb-8">
                    <div class="absolute -left-12 top-0 flex items-center justify-center w-10 h-10 bg-[#008CA6] text-white rounded-full font-bold">ğŸŒ†</div>
                    <div class="ml-4 p-6 bg-white rounded-lg shadow-md">
                        <h3 class="font-bold text-xl text-[#007399] mb-2">18:30 - 19:00 æ™šé¤</h3>
                        <ul class="list-disc list-inside text-gray-700">
                            <li>åŸåˆ™ï¼šæ¸…æ·¡ã€ä½ç¢³ã€æ—©åƒã€‚</li>
                            <li>å†…å®¹ï¼šå¤§é‡æ°´ç…®èœ + å°‘é‡é¸¡èƒ¸è‚‰/é¸¡è›‹ã€‚</li>
                            <li>é¥®å“ï¼š<strong class="text-red-600">æ¸©çƒ­çš„ç™½å¼€æ°´</strong>ï¼Œç»å¯¹ç¦æ­¢å’–å•¡ã€‚</li>
                        </ul>
                    </div>
                </div>
                
                <!-- æµç¨‹ä¿®æ”¹ï¼šä¿ç•™æ•£æ­¥ï¼Œç§»é™¤çœ‹ä¹¦ -->
                <div class="relative mb-8">
                    <div class="absolute -left-12 top-0 flex items-center justify-center w-10 h-10 bg-[#008CA6] text-white rounded-full font-bold">ğŸš¶</div>
                    <div class="ml-4 p-6 bg-white rounded-lg shadow-md">
                        <h3 class="font-bold text-xl text-[#007399] mb-2">19:30 - 20:00 é¥­åæ´»åŠ¨</h3>
                        <ul class="list-disc list-inside text-gray-700">
                            <li><strong class="text-gray-900">æ•£æ­¥ï¼š</strong> é¥­åä¼‘æ¯15åˆ†é’Ÿåï¼Œç«‹å³æ•£æ­¥ 1 å…¬é‡Œï¼Œå¸®åŠ©æ¶ˆåŒ–å¹¶æ¶ˆè€—è¡€ç³–ã€‚</li>
                        </ul>
                    </div>
                </div>

                <div class="relative mb-8">
                    <div class="absolute -left-12 top-0 flex items-center justify-center w-10 h-10 bg-[#008CA6] text-white rounded-full font-bold">ğŸŒ™</div>
                    <div class="ml-4 p-6 bg-white rounded-lg shadow-md">
                        <h3 class="font-bold text-xl text-[#007399] mb-2">20:30 - 23:00 æ™šé—´ä¹ æƒ¯æ”¹è‰¯</h3>
                        <ul class="list-disc list-inside text-gray-700">
                            <li><strong class="text-gray-900">é¥¥é¥¿æ€¥æ•‘ï¼šï¼š</strong> å”¯ä¸€å…è®¸çš„å¤œå®µæ˜¯ã€é»„ç“œã€‘æˆ–ã€è¥¿çº¢æŸ¿ã€‘ã€‚</li>
                            <li><strong class="text-red-600">ç›®æ ‡å…¥ç¡ï¼šï¼š</strong> 23:00å‰å¿…é¡»ä¸ŠåºŠç¡è§‰ã€‚</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <section class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-3xl font-bold text-center text-[#005A8D] mb-6">ğŸ¥¤ â€œæ— ç³–å¯ä¹â€æˆ˜ç•¥</h2>
                <ul class="list-disc list-inside space-y-3 text-gray-700">
                    <li><strong class="text-[#007399]">é“å¾‹1ï¼šï¼š</strong> ä¸‹åˆ4ç‚¹å‰å–å®Œã€‚æ™šé¤åä¸¥ç¦ï¼ˆå«å’–å•¡å› ï¼‰ã€‚</li>
                    <li><strong class="text-[#007399]">é“å¾‹2ï¼šï¼š</strong> ä¸èƒ½ä»£æ›¿æ°´ã€‚å–ä¸€å¬å¯ä¹ï¼Œå¿…é¡»é¢å¤–å¤šå–ä¸€æ¯ç™½æ°´æ¥æ’é…¸ã€‚</li>
                    <li><strong class="text-[#007399]">é“å¾‹3ï¼šï¼š</strong> ä½œä¸ºâ€œé˜²æš´é£Ÿç›¾ç‰Œâ€ã€‚æƒ³åƒç”œç‚¹æ—¶å…ˆå–åŠç“¶ï¼Œèƒ½æœ‰æ•ˆéª—è¿‡å¤§è„‘ã€‚</li>
                </ul>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-3xl font-bold text-center text-[#005A8D] mb-6">ğŸƒâ€â™‚ï¸ â€œå¾®è¿åŠ¨â€ç­–ç•¥</h2>
                <ul class="list-disc list-inside space-y-3 text-gray-700">
                    <li><strong class="text-[#007399]">åˆåï¼ˆå¿…åšï¼‰ï¼šï¼š</strong> æ•£æ­¥1å…¬é‡Œã€‚</li>
                    <li><strong class="text-[#007399]">çœ‹ä¹¦æ—¶ï¼šï¼š</strong> é å¢™é™è¹²ï¼ˆ1åˆ†é’Ÿ x 3ç»„ï¼‰ï¼Œæé«˜èƒ°å²›ç´ æ•æ„Ÿæ€§ã€‚</li>
                    <li><strong class="text-[#007399]">ç¡å‰ï¼šï¼š</strong> ç©ºä¸­è¹¬è½¦ï¼ˆ50-100ä¸ªï¼‰ï¼Œæ¶ˆè€—æœ€åçš„çƒ­é‡ã€‚</li>
                </ul>
            </div>
        </section>

        <footer class="text-center p-6 bg-[#004080] text-white rounded-lg shadow-inner">
            <h2 class="text-2xl font-bold mb-4">ğŸ’Š ç‰¹åˆ«æé†’</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-yellow-100 text-yellow-800 p-4 rounded-lg">
                    <strong class="block">è¯ç‰©è°ƒæ•´ï¼</strong>
                    <p>éšä½“é‡ä¸‹é™ï¼Œå¿…é¡»ç›‘æµ‹è¡€ç³–ï¼Œå¹¶å’¨è¯¢åŒ»ç”Ÿè°ƒæ•´é™ç³–è¯é‡ï¼Œé˜²æ­¢ä½è¡€ç³–ï¼</p>
                </div>
                <div class="bg-blue-100 text-blue-800 p-4 rounded-lg">
                    <strong class="block">ç—›é£è¡¥æ°´ï¼</strong>
                    <p>æ¯å¤©å¿…é¡»å–å¤Ÿ 3000ml æ°´ä¿ƒè¿›å°¿é…¸æ’æ³„ã€‚å’–å•¡åˆ©å°¿ï¼Œå–å®Œè¦é¢å¤–è¡¥æ°´ã€‚</p>
                </div>
            </div>
        </footer>

    </div>

    <script>
        // --- AI API é…ç½® (DeepSeek / Moonshot / å›½å†…é€šç”¨æ¥å£) ---
        // æ­¥éª¤ï¼š
        // 1. è®¿é—® https://platform.deepseek.com/ æ³¨å†Œå¹¶ç”³è¯· API Key
        // 2. å°† Key å¡«å…¥ä¸‹æ–¹å¼•å·ä¸­
        // âš ï¸ è­¦å‘Šï¼šç¡®ä¿æ‚¨çš„ DeepSeek è´¦æˆ·æœ‰è¶³å¤Ÿä½™é¢ï¼Œå¦åˆ™ API ä¼šè¿”å› 402 é”™è¯¯ã€‚
        const apiKey = "sk-a5c524e69b2642bf88e49beba1950552"; // 3. åµŒå…¥ç”¨æˆ·æä¾›çš„ Key
        
        // DeepSeek é…ç½® (æ— éœ€ VPNï¼Œå›½å†…ç›´è¿)
        const API_URL = "https://api.deepseek.com/chat/completions";
        const MODEL_NAME = "deepseek-chat";

        // --- é€šç”¨ AI è°ƒç”¨å‡½æ•° (OpenAI å…¼å®¹æ ¼å¼) ---
        async function callAI(prompt, systemInstruction = "") {
            const apiResultDiv = document.getElementById('analysisResult') || document.getElementById('foodResult') || document.getElementById('sosResult');
            
            if (!apiKey) {
                const missingKeyMsg = "é”™è¯¯ï¼šAI API Key ç¼ºå¤±ï¼è¯·åœ¨ä»£ç ä¸­å¡«å…¥æ‚¨çš„ DeepSeek API Key æ‰èƒ½ä½¿ç”¨ AI åŠŸèƒ½ã€‚";
                return missingKeyMsg;
            }
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: MODEL_NAME,
                        messages: [
                            { role: "system", content: systemInstruction },
                            { role: "user", content: prompt }
                        ],
                        stream: false
                    })
                });

                if (!response.ok) {
                    let errorDetail = `Status: ${response.status}.`;
                    let errorMessage = "AI è¯·æ±‚å¤±è´¥ï¼š";
                    try {
                        const errData = await response.json();
                        errorDetail += ` Detail: ${JSON.stringify(errData)}`;

                        if (response.status === 402 && errData.error && errData.error.message.includes("Insufficient Balance")) {
                            errorMessage += "ã€ä½™é¢ä¸è¶³ã€‘ã€‚è¯·å……å€¼æ‚¨çš„ DeepSeek è´¦æˆ·ã€‚";
                        } else if (response.status === 401) {
                            errorMessage += "ã€æˆæƒå¤±è´¥ã€‘ã€‚è¯·æ£€æŸ¥æ‚¨çš„ API Key æ˜¯å¦æ­£ç¡®ã€‚";
                        } else {
                            errorMessage += `æœåŠ¡å™¨é”™è¯¯ (${response.status})ã€‚è¯·æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦æƒ…ã€‚`;
                        }
                    } catch (e) {
                        const errorText = await response.text();
                        errorDetail += ` Non-JSON Body: ${errorText}`;
                        errorMessage += `ç½‘ç»œæˆ–æœåŠ¡é”™è¯¯ (${response.status})ã€‚`;
                    }
                    console.error("API Error Detail:", errorDetail);
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                return data.choices[0].message.content;
            } catch (error) {
                console.error("AI API Catch Block Error:", error);
                
                let userMessage = error.message || "æŠ±æ­‰ï¼ŒAI åŠ©æ‰‹è¿æ¥å¤±è´¥ã€‚è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•ã€‚";

                return userMessage;
            }
        }

        // --- Feature 1: Food Analyzer ---
        async function analyzeFood() {
            const input = document.getElementById('foodInput').value;
            if (!input) return;

            const btnText = document.getElementById('foodBtnText');
            const resultDiv = document.getElementById('foodResult');
            
            // Loading State
            btnText.innerHTML = '<span class="loader"></span> åˆ†æä¸­...';
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<p class="text-gray-500 text-center">æ­£åœ¨æŸ¥è¯¢ GI å€¼å’Œå˜Œå‘¤å«é‡...</p>';

            const systemPrompt = `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ä¸´åºŠè¥å…»å¸ˆï¼Œæ­£åœ¨æŒ‡å¯¼ä¸€ä½39å²çš„ç”·æ€§å‡é‡ï¼ˆç›®æ ‡100kg->75kgï¼‰ã€‚
            é‡è¦ç—…å²ï¼šä»–æ‚£æœ‰ã€äºŒå‹ç³–å°¿ç—…ã€‘å’Œã€ç—›é£ã€‘ã€‚
            ä»»åŠ¡ï¼šåˆ†æç”¨æˆ·è¾“å…¥çš„é£Ÿç‰©æ˜¯å¦é€‚åˆä»–åƒã€‚
            è¾“å‡ºæ ¼å¼è¦æ±‚ï¼šè¯·ç”¨Markdownæ ¼å¼ã€‚
            1. é¦–å…ˆç»™å‡ºä¸€ä¸ªEmojiçº¢ç»¿ç¯åˆ¤æ–­ï¼šğŸŸ¢ (æ¨è/å®‰å…¨) / ğŸŸ¡ (é€‚é‡/å°å¿ƒ) / ğŸ”´ (ç¦æ­¢/å±é™©)ã€‚
            2. ä½¿ç”¨#### å››çº§æ ‡é¢˜è¡¨ç¤ºå„ä¸ªåˆ†æé¡¹ï¼Œä¾‹å¦‚ #### è¡€ç³–å½±å“ã€‚
            3. **è¡€ç³–å½±å“**ï¼šç®€è¿°GIå€¼æˆ–ç³–è´Ÿè·ã€‚
            4. **ç—›é£å½±å“**ï¼šç®€è¿°å˜Œå‘¤å«é‡ã€‚
            5. **å»ºè®®**ï¼šå¦‚æœä¸åƒï¼Œç»™å‡ºæ›¿ä»£æ–¹æ¡ˆï¼›å¦‚æœåƒï¼Œç»™å‡ºåˆ†é‡å»ºè®®ã€‚
            ä¿æŒè¯­æ°”ä¸“ä¸šä½†äº²åˆ‡ã€‚`;

            const userPrompt = `æˆ‘æƒ³åƒï¼š${input}ã€‚è¯·åˆ†æã€‚`;

            try {
                const result = await callAI(userPrompt, systemPrompt);
                // Check if the result is an error message (i.e., starts with "é”™è¯¯" or "AI è¯·æ±‚å¤±è´¥")
                if (result.startsWith("é”™è¯¯") || result.startsWith("AI è¯·æ±‚å¤±è´¥")) {
                    resultDiv.innerHTML = `<p class="text-red-600 font-bold">${result}</p>`;
                } else {
                    // ä½¿ç”¨ marked.parse è§£æ Markdownï¼Œç¡®ä¿å†…å®¹ç»“æ„åŒ–
                    resultDiv.innerHTML = marked.parse(result);
                }
            } catch (e) {
                resultDiv.innerHTML = "ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•ã€‚";
            } finally {
                btnText.innerText = 'åˆ†æ';
            }
        }

        // --- Feature 2: SOS Motivation ---
        async function getMotivation() {
            const btnText = document.getElementById('sosBtnText');
            const btnIcon = document.getElementById('sosBtnIcon');
            const resultDiv = document.getElementById('sosResult');

            // Loading State
            btnText.innerText = 'æ­£åœ¨ä¸ºæ‚¨å‘¼å«ç´§æ€¥æ”¯æ´...';
            btnIcon.innerText = 'â³';
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<p class="text-gray-500">è¿æ¥æ•™ç»ƒä¸­...</p>';

            // 2. ä¼˜åŒ–ç³»ç»Ÿæç¤ºè¯ï¼Œå¢åŠ å›å¤ä¸°å¯Œåº¦
            const systemPrompt = `ä½ æ˜¯ä¸€ä½ä¸¥å‰ä½†è´Ÿè´£ä»»çš„å‡é‡æ•™ç»ƒã€‚ä½ çš„å­¦å‘˜æ˜¯39å²ç”·æ€§ï¼Œ100kgï¼Œæœ‰ç³–å°¿ç—…å’Œç—›é£ã€‚
            ç°åœ¨çš„åœºæ™¯æ˜¯ï¼šæ·±å¤œï¼Œä»–æƒ³ç‚¹å¤–å–/æš´é£Ÿã€‚
            ä»»åŠ¡ï¼šç»™å‡ºä¸€å¥ç®€çŸ­æœ‰åŠ›çš„è¯ï¼ˆä¸è¶…è¿‡50å­—ï¼‰ï¼Œæ‰“æ¶ˆä»–çš„å¿µå¤´ã€‚
            å…³é”®ï¼šä½ å¿…é¡»åœ¨æ¯æ¬¡å›å¤ä¸­å˜åŒ–åŠè¯«çš„è§’åº¦å’Œè¯­æ°”ã€‚éšæœºé€‰æ‹©ä»¥ä¸‹è§’åº¦ä¹‹ä¸€ï¼š
            1. æé†’ä»–ã€ç—›é£å‘ä½œã€‘æ—¶çš„å‰§ç—›ï¼Œå’Œé«˜å˜Œå‘¤é£Ÿç‰©çš„å±é™©ã€‚
            2. æé†’ä»–æ˜æ—©ã€è¡€ç³–æ•°å€¼ã€‘ä¼šé£™å‡ï¼Œä»¥åŠå‰åŠŸå°½å¼ƒçš„ä»£ä»·ã€‚
            3. æé†’ä»–è·ç¦»ã€75kgç›®æ ‡ã€‘åªå·®ä¸€æ­¥ï¼Œç°åœ¨æ”¾å¼ƒéå¸¸å¯æƒœã€‚
            4. æé†’ä»–å‰å‡ å¤©ã€ä½“é‡ä¸‹é™ã€‘çš„åŠªåŠ›å’Œæˆå°±ï¼Œä¸è¦è®©ä¸€é¡¿å¤–å–æ¯äº†å®ƒã€‚
            5. æé†’ä»–ã€ä¼˜è´¨ç¡çœ ã€‘æ‰æ˜¯å¯¹æŠ—é¥¥é¥¿çš„æœ€å¥½æ–¹æ³•ã€‚
            è¾“å‡ºï¼šåªéœ€è¾“å‡ºé‚£ä¸€å¥åŠè¯«çš„è¯ï¼Œä¸éœ€è¦ä»»ä½•è§£é‡Šæˆ–Markdownæ ¼å¼ã€‚`;

            const userPrompt = "æˆ‘æƒ³ç‚¹å¤–å–ï¼Œæˆ‘å¾ˆé¥¿ï¼Œæˆ‘è¦æ§åˆ¶ä¸ä½äº†ï¼";

            try {
                const result = await callAI(userPrompt, systemPrompt);
                if (result.startsWith("é”™è¯¯") || result.startsWith("AI è¯·æ±‚å¤±è´¥")) {
                    resultDiv.innerHTML = `<p class="text-red-600 font-bold">${result}</p>`;
                } else {
                    resultDiv.innerHTML = `<p class="text-xl font-bold text-red-700">"${result}"</p>`;
                }
            } catch (e) {
                resultDiv.innerHTML = "æ·±å‘¼å¸ï¼Œå–æ¯æ°´ï¼Œå†å»ç¡è§‰ï¼";
            } finally {
                btnText.innerText = 'æˆ‘æƒ³ç‚¹å¤–å–ï¼æ•‘æ•‘æˆ‘ï¼';
                btnIcon.innerText = 'ğŸš¨';
            }
        }

        // --- Weight Tracker Logic ---
        // *** START: Initial data provided by user (stored in kg, converted from æ–¤) ***
        let weightHistory = JSON.parse(localStorage.getItem('myWeightHistory')) || [
            { date: '2025-10-09', weight: 101.35 },
            { date: '2025-10-10', weight: 101.70 },
            { date: '2025-10-11', weight: 100.05 },
            { date: '2025-10-12', weight: 100.05 },
            { date: '2025-10-13', weight: 100.35 },
            { date: '2025-10-14', weight: 100.05 },
            { date: '2025-10-15', weight: 100.10 },
            { date: '2025-10-16', weight: 99.70 },
            { date: '2025-10-17', weight: 98.95 },
            { date: '2025-10-18', weight: 99.50 },
            { date: '2025-10-19', weight: 100.00 },
            { date: '2025-10-20', weight: 100.50 },
            { date: '2025-10-21', weight: 99.60 },
            { date: '2025-10-22', weight: 99.30 },
            { date: '2025-10-23', weight: 98.20 },
            { date: '2025-10-24', weight: 98.95 },
            { date: '2025-10-25', weight: 99.20 },
            { date: '2025-10-26', weight: 99.95 },
            { date: '2025-10-27', weight: 100.40 },
            { date: '2025-10-28', weight: 99.80 },
            { date: '2025-10-29', weight: 99.50 },
            { date: '2025-10-30', weight: 99.35 },
            { date: '2025-10-31', weight: 99.55 },
            { date: '2025-11-01', weight: 100.00 },
            { date: '2025-11-02', weight: 100.50 },
            { date: '2025-11-03', weight: 101.00 },
            { date: '2025-11-04', weight: 99.80 },
            { date: '2025-11-05', weight: 99.15 },
            { date: '2025-11-06', weight: 98.55 },
            { date: '2025-11-07', weight: 98.80 },
            { date: '2025-11-08', weight: 99.25 },
            { date: '2025-11-09', weight: 99.65 },
            { date: '2025-11-10', weight: 100.10 },
            { date: '2025-11-11', weight: 99.15 },
            { date: '2025-11-12', weight: 98.25 },
            { date: '2025-11-13', weight: 98.25 },
            { date: '2025-11-14', weight: 98.30 },
            { date: '2025-11-15', weight: 98.40 },
            { date: '2025-11-16', weight: 98.45 },
            { date: '2025-11-17', weight: 98.55 },
            { date: '2025-11-18', weight: 98.65 },
            { date: '2025-11-19', weight: 98.55 },
            { date: '2025-11-20', weight: 98.45 },
            { date: '2025-11-21', weight: 98.35 },
            { date: '2025-11-22', weight: 98.25 },
            { date: '2025-11-23', weight: 98.60 },
            { date: '2025-11-24', weight: 99.10 },
            { date: '2025-11-25', weight: 98.20 } // Current weight is 196.4 æ–¤
        ];
        // *** END: Initial data provided by user (stored in kg, converted from æ–¤) ***

        let progressChart;

        function addWeightRecord() {
            const date = document.getElementById('weightDate').value;
            const weightInJin = parseFloat(document.getElementById('weightValue').value); // Input is now in æ–¤

            if (!date || !weightInJin || weightInJin <= 0) {
                // Using an inline div instead of alert
                const inputArea = document.querySelector('.lg\\:col-span-1.space-y-6');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'p-3 bg-yellow-100 text-yellow-800 rounded-lg text-sm';
                errorDiv.textContent = 'è¯·å¡«å†™æ—¥æœŸå’Œæœ‰æ•ˆä½“é‡å€¼ (æ–¤)ï¼';
                inputArea.insertBefore(errorDiv, inputArea.firstChild);
                setTimeout(() => errorDiv.remove(), 3000);
                return;
            }

            // *** CHANGE: Convert æ–¤ to kg for internal storage ***
            const weightInKg = weightInJin / 2; 

            // Check for existing date and update if found
            const existingIndex = weightHistory.findIndex(record => record.date === date);

            if (existingIndex !== -1) {
                // Update existing record
                weightHistory[existingIndex].weight = weightInKg;
            } else {
                // Add new record (store in kg)
                weightHistory.push({ date, weight: weightInKg });
            }
            
            // Sort by date
            weightHistory.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Save to LocalStorage
            localStorage.setItem('myWeightHistory', JSON.stringify(weightHistory));

            // Update UI
            renderWeightHistory();
            updateProgressChart();
            // Also update the timeline chart trend
            initTimelineChart(); 
            document.getElementById('weightValue').value = '';
        }

        function deleteWeightRecord(index) {
            // Replaced confirm() with a visual indication for deletion
            const isConfirmed = true; // In a real app, this would be a custom modal confirmation
            if(isConfirmed) {
                // We are using the index from the original, sorted array here
                weightHistory.splice(index, 1);
                localStorage.setItem('myWeightHistory', JSON.stringify(weightHistory));
                renderWeightHistory();
                updateProgressChart();
                initTimelineChart(); // Update trend
            }
        }

        function renderWeightHistory() {
            const tbody = document.getElementById('weightHistoryBody');
            tbody.innerHTML = '';
            
            // Define goal weight (in kg)
            const goalWeightKg = 75.0; // 150 æ–¤

            // Show last 5 records, reversed (newest first) for list
            const recentHistory = [...weightHistory].reverse().slice(0, 5);
            
            // Get elements for the Core Target section (Section 3)
            const initialWeightStat = document.getElementById('initialWeightStat'); // èµ·å§‹ä½“é‡
            const weightLostStat = document.getElementById('weightLostStat');       // å·²å‡ä½“é‡

            if (weightHistory.length > 0) {
                // 1. Get Initial Weight (The earliest record)
                const initialWeightKg = weightHistory[0].weight;
                const initialWeightJin = (initialWeightKg * 2).toFixed(1);

                // 2. Get Current Weight (The latest record)
                const currentWeightKg = weightHistory[weightHistory.length-1].weight;
                const currentWeightJin = (currentWeightKg * 2).toFixed(1);
                
                // 3. Calculate Weight Lost: Initial - Current
                const weightLostKg = initialWeightKg - currentWeightKg;
                const weightLostJin = (weightLostKg * 2).toFixed(1); 

                // Update the *top* current weight display in the tracker section
                document.getElementById('currentWeightDisplay').innerText = `å½“å‰: ${currentWeightJin} æ–¤`;
                
                // Update the Core Target Section (Section 3)
                // Card 1: èµ·å§‹ä½“é‡ (Initial Weight)
                initialWeightStat.innerHTML = `${initialWeightJin}<span class="text-2xl">æ–¤</span>`;
                
                // Card 2: ç›®æ ‡ä½“é‡ (Goal Weight) - Remains static 150 æ–¤

                // Card 3: å·²å‡ä½“é‡ (Weight Lost)
                weightLostStat.innerHTML = `${weightLostJin}<span class="text-2xl">æ–¤</span>`;
                
            } else {
                // Fallback if no data
                document.getElementById('currentWeightDisplay').innerText = `å½“å‰: -- æ–¤`;
                initialWeightStat.innerHTML = `--<span class="text-2xl">æ–¤</span>`;
                weightLostStat.innerHTML = `--<span class="text-2xl">æ–¤</span>`; 
            }


            recentHistory.forEach((record, reverseIndex) => {
                // Find the index in the original (sorted) history to ensure we use the correct index for deletion
                const originalIndex = weightHistory.findIndex(r => r.date === record.date && r.weight === record.weight);

                let change = '-';
                let changeClass = '';
                
                // Compare with the previous day in the original sorted array
                if (originalIndex > 0) {
                    const prevRecord = weightHistory[originalIndex - 1];
                    const diffKg = (record.weight - prevRecord.weight); // diff in kg
                    const diffJin = (diffKg * 2).toFixed(1); // diff in æ–¤
                    
                    if (diffJin > 0) {
                        change = `+${diffJin}`; // Display diff in æ–¤
                        changeClass = 'text-red-500';
                    } else if (diffJin < 0) {
                        change = `${diffJin}`; // Display diff in æ–¤
                        changeClass = 'text-green-600 font-bold';
                    } else {
                        change = '0.0';
                    }
                }

                // Display weight in æ–¤
                const weightInJin = (record.weight * 2).toFixed(1);

                // We pass the index from the original, non-reversed array to deleteWeightRecord
                const row = `<tr class="bg-white border-b hover:bg-gray-50 table-row-animate">
                    <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${record.date}</td>
                    <td class="px-6 py-4">${weightInJin}</td><!-- æ˜¾ç¤ºä¸º æ–¤ -->
                    <td class="px-6 py-4 ${changeClass}">${change}</td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="deleteWeightRecord(${originalIndex})" class="font-medium text-red-600 hover:underline">åˆ é™¤</button>
                    </td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }


        function initProgressChart() {
            const ctx = document.getElementById('progressChart');
            if (!ctx) return;
            progressChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'ä½“é‡è¿›ç¨‹ (kg)', // ä¿æŒå›¾è¡¨æ•°æ®ä¸º kg, æ ‡ç­¾å¯æ˜¾ç¤º kg
                        data: weightHistory.map(item => ({x: item.date, y: item.weight})), // Data is in kg
                        borderColor: '#007399',
                        backgroundColor: 'rgba(0, 115, 153, 0.1)',
                        borderWidth: 2,
                        pointRadius: 4,
                        pointBackgroundColor: '#ffffff',
                        pointBorderColor: '#007399',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                displayFormats: {
                                    day: 'MM-dd'
                                }
                            },
                            grid: { display: false }
                        },
                        y: {
                            min: 70, // Base min on goal in kg
                            suggestedMax: 105,
                            grid: { color: '#f3f4f6' },
                             title: {
                                display: true,
                                text: 'ä½“é‡ (kg)' // æ˜ç¡® Y è½´å•ä½
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function updateProgressChart() {
            if (progressChart) {
                progressChart.data.datasets[0].data = weightHistory.map(item => ({x: item.date, y: item.weight}));
                progressChart.update();
            }
        }

        async function analyzeProgress() {
            if (weightHistory.length < 2) {
                // Using an inline div instead of alert
                const analysisArea = document.querySelector('.lg\\:col-span-1.space-y-6');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'p-3 bg-yellow-100 text-yellow-800 rounded-lg text-sm';
                errorDiv.textContent = 'è¯·è‡³å°‘è®°å½•2å¤©çš„ä½“é‡æ•°æ®æ‰èƒ½è¿›è¡Œåˆ†æï¼';
                analysisArea.insertBefore(errorDiv, analysisArea.querySelector('#analyzeBtnText').parentNode.parentNode.nextSibling);
                setTimeout(() => errorDiv.remove(), 3000);
                return;
            }

            const btnText = document.getElementById('analyzeBtnText');
            const resultDiv = document.getElementById('analysisResult');
            
            btnText.innerHTML = '<span class="loader"></span> AI æ€è€ƒä¸­...';
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = 'æ­£åœ¨è¯»å–æ‚¨çš„ä½“é‡æ•°æ®å¹¶åˆ†æè¶‹åŠ¿...';

            // Prepare data string for AI
            const recentData = weightHistory.slice(-14); // Last 14 records max
            // IMPORTANT: Send data to AI in the expected format (kg) but add æ–¤ in the prompt for clarity
            const dataStr = recentData.map(r => `${r.date}: ${(r.weight * 2).toFixed(1)}æ–¤ (${r.weight.toFixed(1)}kg)`).join('\n'); 

            const systemPrompt = `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ä½“é‡ç®¡ç†æ•™ç»ƒã€‚
            ç”¨æˆ·ç”»åƒï¼š39å²ç”·æ€§ï¼ŒäºŒå‹ç³–å°¿ç—…ï¼Œç—›é£ï¼Œåˆå§‹ä½“é‡101.35kg (202.7æ–¤)ï¼Œç›®æ ‡75kg (150æ–¤)ã€‚
            ä»»åŠ¡ï¼šæ ¹æ®ç”¨æˆ·çš„ä½“é‡è®°å½•è¿›è¡Œâ€œå¤ç›˜â€ã€‚
            åˆ†æè§’åº¦ï¼š
            1. æ€»ä½“è¶‹åŠ¿ï¼ˆæ‰ç§¤å¿«/æ…¢/å¹³å°æœŸï¼‰ã€‚
            2. å¦‚æœæœ‰åå¼¹ï¼Œç»™äºˆå®‰æ…°å’ŒåŸå› æ¨æµ‹ï¼ˆå¦‚å¯èƒ½æ°´è‚¿ã€èšé¤ï¼‰ã€‚
            3. ç»™äºˆå¼ºçƒˆçš„é¼“åŠ±ã€‚
            è¯·ç”¨Markdownæ ¼å¼ï¼Œç®€çŸ­æœ‰åŠ›ï¼Œä¸è¶…è¿‡100å­—ã€‚`;

            const userPrompt = `è¿™æ˜¯æˆ‘æœ€è¿‘çš„ä½“é‡è®°å½•ï¼ˆå•ä½æ˜¯æ–¤/kgï¼‰ï¼š\n${dataStr}\nè¯·åˆ†ææˆ‘çš„è¿›åº¦ã€‚`;

            try {
                const result = await callAI(userPrompt, systemPrompt);
                if (result.startsWith("é”™è¯¯") || result.startsWith("AI è¯·æ±‚å¤±è´¥")) {
                    resultDiv.innerHTML = `<p class="text-red-600 font-bold">${result}</p>`;
                } else {
                    resultDiv.innerHTML = marked.parse(result);
                }
            } catch (e) {
                resultDiv.innerHTML = "åˆ†æå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚";
            } finally {
                btnText.innerText = 'âœ¨ åˆ†ææˆ‘çš„è¿›åº¦';
            }
        }

        // --- Timeline Chart Logic (Revised for Realistic/Decaying Trend) ---
        let timelineChart;
        
        // 1. Define Target Data (Milestones) with clearer dates
        const targetMilestones = [
            { date: '2025-10-09', weight: 101.35, label: 'èµ·å§‹ (202.7æ–¤)' }, // Use actual start date and weight
            { date: '2025-12-26', weight: 95.0, label: '1æœˆé‡Œç¨‹ç¢‘ (190æ–¤)' }, 
            { date: '2026-01-26', weight: 90.0, label: '2æœˆé‡Œç¨‹ç¢‘ (180æ–¤)' }, 
            { date: '2026-02-26', weight: 85.0, label: '3æœˆé‡Œç¨‹ç¢‘ (170æ–¤)' }, 
            { date: '2026-03-26', weight: 75.0, label: 'æœ€ç»ˆç›®æ ‡ (150æ–¤)' } 
        ];

        function calculateRealisticTrend(history) {
            if (history.length < 5) return []; // Need some data
            
            // 1. Calculate current linear velocity (slope) based on last 21 days
            const recentHistory = history.slice(-21); 
            const dataPoints = recentHistory.map(r => {
                // Convert dates to numeric value (days since first point in window)
                const days = (new Date(r.date) - new Date(recentHistory[0].date)) / (1000 * 60 * 60 * 24);
                return { x: days, y: r.weight };
            });

            // Simple Linear Regression
            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
            const n = dataPoints.length;
            for (const p of dataPoints) {
                sumX += p.x;
                sumY += p.y;
                sumXY += p.x * p.y;
                sumXX += p.x * p.x;
            }
            // Slope m (kg/day)
            // Handle division by zero if all dates are the same
            let currentRate = 0;
            if ((n * sumXX - sumX * sumX) !== 0) {
                 currentRate = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            }
            
            // 2. Generate Decay Curve Projection
            const projection = [];
            const lastRecord = recentHistory[recentHistory.length - 1];
            const lastDate = new Date(lastRecord.date);
            const endDate = new Date('2026-03-26');
            
            // Start point
            projection.push({ x: lastRecord.date, y: lastRecord.weight });

            let currentDate = new Date(lastDate);
            let currentWeight = lastRecord.weight;
            
            // Physiologically, weight loss slows down. 
            // Assumption: Loss rate decays by ~0.3% per day (approx 10% per month)
            const decayPerDay = 0.003; 

            // If rate is positive (gaining), we don't decay it (keep warning linear)
            // If rate is extremely fast (>0.3kg/day), clamp it to avoid unrealistic drops
            if (currentRate < -0.3) currentRate = -0.3;

            while (currentDate < endDate) {
                // Step forward 7 days
                currentDate.setDate(currentDate.getDate() + 7);
                
                if (currentRate < 0) {
                    // Apply decay over 7 days
                    for(let i=0; i<7; i++) {
                        currentWeight += currentRate;
                        currentRate = currentRate * (1 - decayPerDay); 
                    }
                } else {
                    // Linear projection for gaining (warning)
                    currentWeight += currentRate * 7;
                }

                // Stop if weight goes below realistic human limits (e.g., 50kg)
                if (currentWeight < 50) currentWeight = 50;

                if (currentDate > endDate) currentDate = endDate; 

                projection.push({ 
                    x: currentDate.toISOString().split('T')[0], 
                    y: parseFloat(currentWeight.toFixed(2)) 
                });
                
                if (currentDate.getTime() === endDate.getTime()) break;
            }

            return projection;
        }

        function initTimelineChart() {
            const ctx = document.getElementById('weightLossTimeline');
            if (!ctx) return;
            
            // If chart exists, destroy it to re-render with new data
            if (timelineChart) {
                timelineChart.destroy();
            }

            const trendData = calculateRealisticTrend(weightHistory);

            timelineChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'æ ‡å‡†ç›®æ ‡è·¯å¾„ (Burndown)',
                            data: targetMilestones.map(t => ({x: t.date, y: t.weight})),
                            borderColor: '#10B981', // Green
                            borderDash: [5, 5], // Dashed
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            pointRadius: 5,
                            pointStyle: 'rectRot', // Distinct point style
                            tension: 0 // Straight lines between milestones
                        },
                        {
                            label: 'å®é™…ä½“é‡',
                            data: weightHistory.map(item => ({x: item.date, y: item.weight})),
                            borderColor: '#007399', // Blue
                            backgroundColor: 'rgba(0, 115, 153, 0.1)',
                            borderWidth: 2,
                            pointRadius: 2,
                            tension: 0.1
                        },
                        {
                            label: 'æ™ºèƒ½è¶‹åŠ¿é¢„æµ‹ (å«ä»£è°¢è¡°å‡)',
                            data: trendData,
                            borderColor: '#F59E0B', // Orange/Yellow
                            borderDash: [2, 2], // Dotted
                            borderWidth: 2,
                            pointRadius: 0, // No points on the line
                            fill: false,
                            tension: 0.4 // Curved line for natural look
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'month',
                                displayFormats: {
                                    month: 'yyyy-MM'
                                }
                            },
                            grid: { color: '#E5E7EB' }
                        },
                        y: {
                            min: 70, 
                            suggestedMax: 105, 
                            title: {
                                display: true,
                                text: 'ä½“é‡ (kg)'
                            }
                        }
                    },
                    plugins: {
                         tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += (context.parsed.y * 2).toFixed(1) + ' æ–¤';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }


        function initApp() {
            // Set default date input
            document.getElementById('weightDate').valueAsDate = new Date();
            
            // Initialize tracker UI and chart
            renderWeightHistory();
            initProgressChart();
            
            // Initialize updated timeline chart with trend
            initTimelineChart();
        }

        // Wait for the entire page (including all elements) to load before initializing charts
        window.onload = initApp;

        document.addEventListener('DOMContentLoaded', () => {
             // Find the misplace button wrapper and move it.
             const misplacedDiv = document.querySelector('section:nth-of-type(6) > div > div > div:nth-child(1)');
             if (misplacedDiv && misplacedDiv.querySelector('#analyzeBtnText')) {
                // Find the correct target location (in the Weight Tracker section)
                const targetLocation = document.querySelector('.lg\\:col-span-1.space-y-6 > div:last-child');
                if (targetLocation) {
                    // Check if the element hasn't been moved already
                    const analysisBtnWrapper = targetLocation.querySelector('#analyzeBtnText');
                    if (!analysisBtnWrapper) {
                        targetLocation.innerHTML = misplacedDiv.innerHTML;
                        misplacedDiv.remove();
                    }
                }
             }
        });
    </script>

</body>
</html>
